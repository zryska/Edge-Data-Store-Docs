<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Edge Data Store Analytics quick start </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Edge Data Store Analytics quick start ">
    <meta name="generator" content="docfx 2.43.2.0">
    
    <link rel="shortcut icon" href="../../favicon.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../../toc.html">
    
    <meta property="docfx:rel" content="../../">
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="../../Beta2/index.html" width="46">
                <img id="logo" src="../../Beta2/images/atlas_icon.png" height="46" width="46" alt="OSIsoft Edge System"> 
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list"></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        <div class="article row grid">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="analyticsQuickStart">
<h1 id="edge-data-store-analytics-quick-start">Edge Data Store Analytics quick start</h1>

<p>This document is a quick tour of a very simple analytic that can written using the Edge Data Store. The intended input device for this example is a Modbus TCP or other sensor that outputs 4 boolean values. The normal range of operation is that the values are neither all true or all false. If all values are true, the exception condition High is triggered. If all values are false, the exception condition Low is triggered. Any other combination of boolean values is Normal. Three analytic streams are created to track these changes. The ValueRangeHigh stream is 1 when High and 0 when anything else. The ValueRangeLow stream is -1 when Low and 0 when anything else. The ValueRangeOut stream is -1 when Low, 0 when Normal, and 1 when High.</p>
<p> This example assumes the Edge Data Store was installed with the default port (5590).</p>
<pre><code class="lang-csharp">using System;
using System.Collections.Generic;
using System.Net.Http;
using System.Text;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;

namespace ExceptionReportingSample
{
    class ModbusField
    {
        public string StreamId { get; set; }
        public int ScanRate { get; set; }
    }

    enum Alert
    {
        Normal,
        High,
        Low
    }
    class ExceptionReporting
    {
        static HttpClient _client = new HttpClient();
        private static List&lt;string&gt; StreamIds = new List&lt;string&gt;(new string[] { &quot;SwitchState1&quot;, &quot;SwitchState2&quot;, &quot;SwitchState3&quot;, &quot;SwitchState4&quot; });
        private const string ValueRangeHigh = &quot;ValueRangeHigh&quot;;
        private const string ValueRangeLow = &quot;ValueRangeLow&quot;;
        private const string ValueRangeOut = &quot;ValueRangeOut&quot;;
        private const string TypeId = &quot;ValueRange&quot;;
        private const string ModbusComponentId = &quot;Modbus1&quot;;
        private const double lowValue = -1.0;
        private const double highValue = 1.0;
        private const double normalValue = 0.0;
        public static Alert _alert = Alert.Normal;

        static TimeSpan GetPollingIntervalFromModbus(string modbusComponentId, List&lt;string&gt; StreamIds)
        {
            int pollingMilliseconds = 5000;
            string endpoint = $&quot;http://localhost:5590/api/v1/configuration/{modbusComponentId}/DataSelection&quot;;
            string modbusConfig = _client.GetStringAsync(endpoint).Result;
            List&lt;ModbusField&gt; values = JsonConvert.DeserializeObject&lt;List&lt;ModbusField&gt;&gt;(modbusConfig);
            foreach (var value in values)
            {
                foreach (string StreamId in StreamIds)
                {
                    if (StreamId == value.StreamId &amp;&amp; value.ScanRate &lt; pollingMilliseconds)
                    {
                        pollingMilliseconds = value.ScanRate;
                    }
                }
            }
            return TimeSpan.FromMilliseconds(pollingMilliseconds);
        }

        static bool GetStreamValue(string StreamId)
        {
            bool value = false;
            string lastValueUri = string.Format(&quot;http://localhost:5590/api/v1/tenants/default/namespaces/default/streams/{0}/Data/Last&quot;, StreamId);
            string lastValueJson = _client.GetStringAsync(lastValueUri).Result;
            Dictionary&lt;string, object&gt; values = JsonConvert.DeserializeObject&lt;Dictionary&lt;string, object&gt;&gt;(lastValueJson);
            object objValue = values[&quot;Value&quot;];
            if (objValue is Boolean) value = (bool)objValue;
            return value;
        }

        static bool FindOrCreateType(string typeId)
        {
            string typeUri = string.Format(&quot;http://localhost:5590/api/v1/tenants/default/namespaces/default/types/{0}&quot;, typeId);
            HttpResponseMessage response = _client.GetAsync(typeUri).Result;
            if (response.IsSuccessStatusCode) return true;
            string typeJson = @&quot;{&quot;&quot;Id&quot;&quot;: &quot;&quot;&quot; + typeId + @&quot;&quot;&quot;,&quot;&quot;Name&quot;&quot;: &quot;&quot;&quot; + typeId + @&quot;&quot;&quot;,&quot;&quot;SdsTypeCode&quot;&quot;: 1,&quot;&quot;Properties&quot;&quot;: [{&quot;&quot;Id&quot;&quot;: &quot;&quot;Time&quot;&quot;,&quot;&quot;Name&quot;&quot;: &quot;&quot;Time&quot;&quot;,&quot;&quot;IsKey&quot;&quot;: true,&quot;&quot;SdsType&quot;&quot;: {&quot;&quot;SdsTypeCode&quot;&quot;: 16}},{&quot;&quot;Id&quot;&quot;: &quot;&quot;Measurement&quot;&quot;,&quot;&quot;Name&quot;&quot;: &quot;&quot;Measurement&quot;&quot;,&quot;&quot;SdsType&quot;&quot;: {&quot;&quot;SdsTypeCode&quot;&quot;: 14}}]}&quot;;
            var content = new StringContent(typeJson, Encoding.UTF8, &quot;application/json&quot;);
            response = _client.PostAsync(typeUri, content).Result;
            return response.IsSuccessStatusCode;
        }

        static bool FindOrCreateStream(string streamId, string typeId)
        {
            string streamUri = string.Format(&quot;http://localhost:5590/api/v1/tenants/default/namespaces/default/streams/{0}/&quot;, streamId);
            HttpResponseMessage response = _client.GetAsync(streamUri).Result;
            if (response.IsSuccessStatusCode) return true;
            string streamJson = @&quot;{&quot;&quot;Id&quot;&quot;: &quot;&quot;&quot; + streamId + @&quot;&quot;&quot;,&quot;&quot;Name&quot;&quot;: &quot;&quot;&quot; + streamId + @&quot;&quot;&quot;,&quot;&quot;TypeId&quot;&quot;: &quot;&quot;&quot; + typeId + @&quot;&quot;&quot;}&quot;;
            var content = new StringContent(streamJson, Encoding.UTF8, &quot;application/json&quot;);
            response = _client.PostAsync(streamUri, content).Result;
            return response.IsSuccessStatusCode;
        }

        static bool WriteStreamValue(string StreamId, double value, DateTime timestamp)
        {
            string dataUri = string.Format(&quot;http://localhost:5590/api/v1/tenants/default/namespaces/default/streams/{0}/Data&quot;, StreamId);
            string dataJson = @&quot;[{&quot;&quot;Time&quot;&quot;: &quot;&quot;&quot; + timestamp.ToString(&quot;o&quot;) + @&quot;&quot;&quot;,&quot;&quot;Measurement&quot;&quot;:&quot; + value.ToString() + &quot;}]&quot;;
            var content = new StringContent(dataJson, Encoding.UTF8, &quot;application/json&quot;);
            HttpResponseMessage response = _client.PostAsync(dataUri, content).Result;
            return response.IsSuccessStatusCode;
        }

        static Alert CheckStatus(int numberTrue)
        {
            if (numberTrue &gt; 3) return Alert.High;
            if (numberTrue &lt; 1) return Alert.Low;
            return Alert.Normal;
        }

        static bool ReportChange(Alert oldAlert, Alert newAlert)
        {
            bool success = true;
            DateTime now = DateTime.UtcNow;
            switch (oldAlert)
            {
                case Alert.Normal:
                    if (Alert.Low == newAlert)
                    {
                        return WriteStreamValue(ValueRangeLow, lowValue, now)
                            &amp;&amp; WriteStreamValue(ValueRangeOut, lowValue, now);
                    }
                    if (Alert.High == newAlert)
                    {
                        return WriteStreamValue(ValueRangeHigh, highValue, now)
                            &amp;&amp; WriteStreamValue(ValueRangeOut, highValue, now);
                    }
                    break;

                case Alert.High:
                    if (Alert.Low == newAlert)
                    {
                        return WriteStreamValue(ValueRangeLow, lowValue, now)
                            &amp;&amp; WriteStreamValue(ValueRangeOut, lowValue, now)
                            &amp;&amp; WriteStreamValue(ValueRangeHigh, normalValue, now);
                    }
                    if (Alert.Normal == newAlert)
                    {
                        return WriteStreamValue(ValueRangeOut, normalValue, now)
                            &amp;&amp; WriteStreamValue(ValueRangeHigh, normalValue, now);
                    }
                    break;

                case Alert.Low:
                    if (Alert.Normal == newAlert)
                    {
                        return WriteStreamValue(ValueRangeOut, normalValue, now)
                            &amp;&amp; WriteStreamValue(ValueRangeLow, normalValue, now);
                    }
                    if (Alert.High == newAlert)
                    {
                        return WriteStreamValue(ValueRangeLow, normalValue, now)
                            &amp;&amp; WriteStreamValue(ValueRangeOut, highValue, now)
                            &amp;&amp; WriteStreamValue(ValueRangeHigh, highValue, now);
                    }
                    break;

                default:
                    break;
            }

            return success;
        }

        static void Main(string[] args)
        {
            TimeSpan pollingInterval = GetPollingIntervalFromModbus(ModbusComponentId, StreamIds);
            FindOrCreateType(TypeId);
            FindOrCreateStream(ValueRangeHigh, TypeId);
            FindOrCreateStream(ValueRangeLow, TypeId);
            FindOrCreateStream(ValueRangeOut, TypeId);
            while (true)
            {
                int numberTrue = 0;
                foreach (string StreamId in StreamIds)
                {
                    bool value = GetStreamValue(StreamId);
                    if (value) numberTrue++;
                }
                Alert currentAlert = CheckStatus(numberTrue);
                if (currentAlert != _alert)
                {
                    if (ReportChange(_alert, currentAlert))
                    {
                        _alert = currentAlert;
                    }
                }
                System.Threading.Thread.Sleep(pollingInterval);
                Console.WriteLine(&quot;ValueRange should be &quot; + _alert);
            }
        }
    }
}
</code></pre></article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/osisoft/Edge-Data-Store-Docs/blob/master/V1/Overview/AnalyticsQuickStart.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
            <span id='copyright-text'>© 2019 - OSIsoft, LLC.<span>
        </span></span></div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
